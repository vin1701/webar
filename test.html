<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Location-based WebAR</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
</head>

<body style="margin: 0; overflow: hidden;">
    <a-scene
        vr-mode-ui="enabled: false"
        arjs="sourceType: webcam; debugUIEnabled: true;"
        renderer="logarithmicDepthBuffer: true;"
        embedded
        gesture-detector
        id="scene">
        
        <a-camera
            id="camera1"
            gps-camera="simulateLatitude: 19.257877; simulateLongitude: 72.963085; simulateAltitude: 300;"
            rotation-reader>
        </a-camera>

        <!-- Box at the specified geolocation -->
        <a-box
            id="box"
            material="color: red;"
            geometry="primitive: box; width: 5; height: 5; depth: 5;"
            gps-entity-place="latitude: 19.257877; longitude: 72.963085;"
            visible="true">
        </a-box>

        <!-- Text label for the location -->
        <a-text
            value="TARGET HERE"
            position="0 8 0"
            align="center"
            color="yellow"
            scale="20 20 20"
            gps-entity-place="latitude: 19.257877; longitude: 72.963085;">
        </a-text>

        <!-- Alternative larger box for testing -->
        <a-cylinder
            material="color: blue; opacity: 0.7;"
            geometry="radius: 3; height: 10;"
            position="0 0 0"
            gps-entity-place="latitude: 19.257877; longitude: 72.963085;">
        </a-cylinder>
    </a-scene>

    <div id="info" style="position: fixed; top: 10px; left: 10px; color: white; font-family: Arial; z-index: 999; background: rgba(0,0,0,0.5); padding: 10px; border-radius: 5px; max-width: 300px;">
        <div id="status">Initializing GPS...</div>
        <div id="coordinates"></div>
        <div id="distance"></div>
        <div id="debug"></div>
    </div>

    <script>
        let userPosition = null;
        const targetLat = 19.257877;//19.2579788;//19.2579788;
        const targetLng = 72.963085;//72.9635206;//72.9635206;
        
        // Update status
        function updateStatus(message) {
            document.getElementById('status').innerHTML = message;
        }

        // Calculate distance between two coordinates using Haversine formula
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // Earth's radius in meters
            const φ1 = lat1 * Math.PI/180;
            const φ2 = lat2 * Math.PI/180;
            const Δφ = (lat2-lat1) * Math.PI/180;
            const Δλ = (lon2-lon1) * Math.PI/180;

            const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
                      Math.cos(φ1) * Math.cos(φ2) *
                      Math.sin(Δλ/2) * Math.sin(Δλ/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

            const distance = R * c;
            return distance;
        }

        function updateDistance(lat, lng) {
            const distance = calculateDistance(lat, lng, targetLat, targetLng);
            document.getElementById('distance').innerHTML = `Distance: ${distance.toFixed(0)}m`;
            
            if (distance < 50) {
                updateStatus('<span style="color: green;">Target is nearby!</span>');
            } else if (distance < 200) {
                updateStatus('<span style="color: yellow;">Getting closer...</span>');
            } else {
                updateStatus('<span style="color: white;">Looking for target...</span>');
            }
        }

        // Use browser geolocation API as fallback
        function startGeolocation() {
            updateStatus('Requesting location permission...');
            
            if (!navigator.geolocation) {
                updateStatus('<span style="color: red;">Geolocation not supported</span>');
                return;
            }

            navigator.geolocation.getCurrentPosition(
                function(position) {
                    userPosition = position;
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    
                    document.getElementById('coordinates').innerHTML = 
                        `Your location: ${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                    
                    updateDistance(lat, lng);
                    
                    // Start watching position
                    navigator.geolocation.watchPosition(
                        function(position) {
                            const lat = position.coords.latitude;
                            const lng = position.coords.longitude;
                            document.getElementById('coordinates').innerHTML = 
                                `Your location: ${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                            updateDistance(lat, lng);
                        },
                        function(error) {
                            updateStatus('<span style="color: red;">Location error: ' + error.message + '</span>');
                        },
                        {
                            enableHighAccuracy: true,
                            maximumAge: 30000,
                            timeout: 27000
                        }
                    );
                },
                function(error) {
                    updateStatus('<span style="color: red;">Location denied or unavailable</span>');
                    document.getElementById('debug').innerHTML = `Error: ${error.message}`;
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 60000
                }
            );
        }

        // Wait for scene to load
        document.addEventListener('DOMContentLoaded', function() {
            const scene = document.querySelector('a-scene');
            
            if (scene.hasLoaded) {
                startGeolocation();
            } else {
                scene.addEventListener('loaded', function() {
                    startGeolocation();
                });
            }
        });

        // Also try GPS camera events
        const camera = document.querySelector('[gps-camera]');
        if (camera) {
            camera.addEventListener('gps-camera-update-position', function(e) {
                if (e.detail && e.detail.position) {
                    const position = e.detail.position;
                    document.getElementById('coordinates').innerHTML = 
                        `GPS Camera: ${position.latitude.toFixed(6)}, ${position.longitude.toFixed(6)}`;
                    updateDistance(position.latitude, position.longitude);
                }
            });

            camera.addEventListener('gps-camera-error', function(e) {
                document.getElementById('debug').innerHTML = `GPS Camera Error: ${e.detail}`;
            });
        }

        // Enhanced GPS entity debugging and management
        document.addEventListener('DOMContentLoaded', function() {
            const scene = document.querySelector('a-scene');
            
            scene.addEventListener('loaded', function() {
                setTimeout(function() {
                    const gpsEntities = document.querySelectorAll('[gps-entity-place]');
                    document.getElementById('debug').innerHTML = `Found ${gpsEntities.length} GPS entities`;
                    
                    gpsEntities.forEach(function(entity, index) {
                        // Make entities more visible
                        entity.setAttribute('visible', true);
                        
                        entity.addEventListener('gps-entity-place-added', function() {
                            console.log('GPS entity added:', entity);
                            document.getElementById('debug').innerHTML = `Entity ${index} placed at GPS location`;
                        });
                        
                        entity.addEventListener('gps-entity-place-loaded', function() {
                            console.log('GPS entity loaded:', entity);
                            document.getElementById('debug').innerHTML += `<br>Entity ${index} loaded and visible`;
                        });
                    });
                    
                    // Force update GPS entities position
                    const camera = document.getElementById('camera1');
                    if (camera.components && camera.components['gps-camera']) {
                        camera.components['gps-camera'].tick();
                    }
                }, 3000);
            });
        });

        // Add compass debugging
        window.addEventListener('deviceorientationabsolute', function(event) {
            const compass = event.alpha; // 0-360 degrees
            if (compass !== null) {
                document.getElementById('debug').innerHTML += `<br>Compass: ${compass.toFixed(0)}°`;
            }
        });

        // Test if entities are being created
        setTimeout(function() {
            const box = document.getElementById('box');
            if (box) {
                // Force the box to be visible and larger
                box.setAttribute('material', 'color: red; opacity: 1;');
                box.setAttribute('geometry', 'width: 10; height: 10; depth: 10;');
                box.setAttribute('visible', true);
                console.log('Box forced to be visible');
            }
        }, 5000);
    </script>
</body>

</html>
